<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pharmacie MTIR – Gestion du Stock</title>

  <!-- Roboto + Material Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    /* RESET & VARIABLES */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: "Roboto", sans-serif; background: #f5f5f5; color: #333; }
    :root {
      --sidebar-width: 240px;
      --sidebar-bg: #fff;
      --border: #e0e0e0;
      --text: #495057;
      --hover: #f8f9fa;
      --active: #f3f4f6;
      --accent: #4b9eff;
      --card-bg: #fff;
      --card-shadow: rgba(0,0,0,0.05);
      --seuil-orange: #fff3cd;
      --seuil-rouge:  #f8d7da;
    }
    body { display: flex; }
    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar-width); background: var(--sidebar-bg);
      border-right: 1px solid var(--border); display: flex; flex-direction: column;
      padding: 24px 0; position: fixed; top: 0; left: 0; bottom: 0;
    }
    .sidebar .brand { display: flex; align-items: center; justify-content: center; margin-bottom: 32px; }
    .sidebar .brand .material-icons { font-size: 32px; color: var(--accent); margin-right: 8px; }
    .sidebar .brand-text { font-size: 20px; font-weight: 700; }
    .sidebar nav { flex: 1; }
    .sidebar nav a { display: flex; align-items: center; padding: 10px 24px; text-decoration: none; color: var(--text); gap: 12px; transition: background .2s; }
    .sidebar nav a.active, .sidebar nav a:hover { background: var(--hover); }
    .sidebar nav .group-title { padding: 0 24px; margin: 16px 0 8px; font-size: 12px; text-transform: uppercase; color: #6c757d; }
    .logout { padding: 16px; border-top: 1px solid var(--border); }
    .logout a { display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; color: var(--text); }

    /* MAIN CONTENT */
    .content {
      margin-left: var(--sidebar-width);
      padding: 32px;
      width: calc(100% - var(--sidebar-width));
      overflow-y: auto;
    }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .page-header h1 { font-size: 28px; }
    #searchInput {
      width: 100%; max-width: 300px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--hover);
    }

    /* TABLE WRAPPER */
    .table-wrapper { overflow-x: auto; }
    .stock-table {
      width: 100%; border-collapse: collapse; background: var(--card-bg);
      box-shadow: 0 4px 12px var(--card-shadow); border-radius: 8px; overflow: hidden;
    }
    .stock-table th, .stock-table td { padding: 12px 16px; text-align: left; }
    .stock-table th { background: #f1f3f5; text-transform: uppercase; font-size: 14px; }
    .stock-table tr:nth-child(even) { background: #fafafa; }
    .stock-table tr:hover { background: var(--hover); }
    .stock-table td.stock, .stock-table td.current { width: 120px; text-align: center; }
    .stock-table td.edit { width: 48px; text-align: center; }
    .stock-table td.edit .material-icons { cursor: pointer; transition: color .2s; }
    .stock-table td.edit .material-icons:hover { color: var(--accent); }
    .category-row td { background: #eef3f7; font-style: italic; color: #6c757d; }

    .stock-table tr.seuil-orange td { background: var(--seuil-orange) !important; }
    .stock-table tr.seuil-rouge  td { background: var(--seuil-rouge)  !important; }

    /* MODAL */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none; align-items: center; justify-content: center;
      z-index: 100;
    }
    .modal {
      background: var(--card-bg); border-radius: 8px; padding: 24px;
      box-shadow: 0 6px 20px var(--card-shadow); width: 90%; max-width: 360px;
      text-align: center;
    }
    .modal input { width: 100%; padding: 10px; margin: 16px 0; border: 1px solid #ccc; border-radius: 6px; }
    .modal .btn { padding: 10px 16px; margin: 0 8px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-cancel { background: #ccc; color: #fff; }
    .btn-cancel:hover { background: #aaa; }
    .btn-save { background: var(--accent); color: #fff; }
    .btn-save:hover { background: #3a8ee6; }

    /* RESPONSIVE */
    @media(max-width: 768px) {
      .sidebar { transform: translateX(-100%); position: absolute; transition: transform .3s; }
      .sidebar.open { transform: translateX(0); }
      .content { margin: 0; width: 100%; }
      .page-header { flex-direction: column; gap: 16px; }
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand"><span class="material-icons">local_pharmacy</span><span class="brand-text">Pharmacie MTIR</span></div>
    <nav>
      <a href="dashboard.html?role=admin"><span class="material-icons">dashboard</span>Tableau de bord</a>
      <div class="group-title">Gestion du Stock</div>
      <a href="stock.html?role=admin" class="active"><span class="material-icons">inventory</span>Stock</a>
      <a href="produit.html?role=admin"><span class="material-icons">add_box</span>Ajouter un produit</a>
      <div class="group-title">Utilisateurs</div>
      <a href="#"><span class="material-icons">group</span>Liste Utilisateurs</a>
      <div class="group-title">Admin</div>
      <a href="#"><span class="material-icons">receipt_long</span>Logs</a>
    </nav>
    <div class="logout"><a href="login.html"><span class="material-icons">logout</span>Déconnexion</a></div>
  </aside>

  <!-- CONTENT -->
  <div class="content">
    <div class="page-header">
      <h1>Gestion du Stock</h1>
      <input type="text" id="searchInput" placeholder="Rechercher un produit…" />
      <!-- mobile menu toggle -->
      <button id="toggleSidebar" class="material-icons" style="display:none;position:absolute;top:16px;right:16px;">menu</button>
    </div>
    <div class="table-wrapper">
      <table class="stock-table">
        <thead>
          <tr><th>Nom du produit</th><th>Quantité en stock</th><th>Quantité actuelle</th><th></th></tr>
        </thead>
        <tbody id="stockTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h2>Modifier la quantité</h2>
      <input type="number" id="modalInput" min="0" />
      <div>
        <button class="btn btn-cancel" id="modalCancel">Annuler</button>
        <button class="btn btn-save" id="modalSave">Enregistrer</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getFirestore, collection, getDocs, updateDoc, doc, orderBy, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    const app = initializeApp({ apiKey:"…", authDomain:"…", projectId:"pharmacie-mtir-db" });
    const db  = getFirestore(app);
    const produitsCol = collection(db, "produits");
    const logsCol     = collection(db, "logs");

    // Sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const toggle  = document.getElementById('toggleSidebar');
    toggle.addEventListener('click', () => sidebar.classList.toggle('open'));

    const stockTbody   = document.getElementById('stockTbody');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalInput   = document.getElementById('modalInput');
    const modalCancel  = document.getElementById('modalCancel');
    const modalSave    = document.getElementById('modalSave');
    const searchInput  = document.getElementById('searchInput');
    let activeRow      = null;

    function addCategoryRow(cat) {
      const tr = document.createElement('tr');
      tr.classList.add('category-row');
      tr.innerHTML = `<td colspan="4">Catégorie : ${cat}</td>`;
      stockTbody.appendChild(tr);
    }

    function addProductRow(prod) {
      const tr = document.createElement('tr');
      tr.dataset.id          = prod.id;
      tr.dataset.seuilOrange = prod.seuilOrange;
      tr.dataset.seuilRouge  = prod.seuilRouge;
      tr.setAttribute('draggable','true');
      tr.innerHTML = `
        <td class="cell-name">${prod.name}</td>
        <td class="stock">${prod.stock}</td>
        <td class="current">${prod.stock}</td>
        <td class="edit"><span class="material-icons">edit</span></td>
      `;
      if(prod.stock <= prod.seuilRouge) tr.classList.add('seuil-rouge');
      else if(prod.stock <= prod.seuilOrange) tr.classList.add('seuil-orange');

      tr.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', prod.id); tr.classList.add('dragging'); });
      tr.addEventListener('dragend', async () => {
        tr.classList.remove('dragging');
        const rows = Array.from(stockTbody.querySelectorAll("tr[draggable='true']"));
        for(let i=0;i<rows.length;i++) await updateDoc(doc(db,'produits',rows[i].dataset.id),{order:i});
        await addDoc(logsCol,{message:'Ordre des produits mis à jour',timestamp:serverTimestamp()});
      });
      tr.addEventListener('dragover', e => {
        e.preventDefault(); const d=document.querySelector('.dragging');
        if(!d||d===tr) return;
        const r=tr.getBoundingClientRect(); const before=(e.clientY-r.top)<r.height/2;
        tr.parentNode.insertBefore(d,before?tr:tr.nextSibling);
      });

      tr.querySelector('td.edit .material-icons').addEventListener('click', () => {
        activeRow = tr;
        modalInput.value = tr.querySelector('td.stock').textContent;
        modalOverlay.style.display = 'flex';
        modalInput.focus();
      });

      stockTbody.appendChild(tr);
    }

    async function loadAllProducts(){
      stockTbody.innerHTML='';
      const q = query(produitsCol, orderBy('__name__','asc'));
      const snap = await getDocs(q);
      let lastCat=null;
      snap.forEach(ds =>{
        const d=ds.data();
        const prod={id:ds.id,name:d.name||'',category:d.category||'',stock:d.stock||0,seuilOrange:d.seuilOrange||0,seuilRouge:d.seuilRouge||0};
        if(prod.category!==lastCat){addCategoryRow(prod.category); lastCat=prod.category;}
        addProductRow(prod);
      });
      filterTable();
    }

    function filterTable(){
      const v=searchInput.value.trim().toLowerCase();
      document.querySelectorAll('#stockTbody tr').forEach(row=>{
        if(row.classList.contains('category-row')) return;
        const name=row.querySelector('.cell-name').textContent.toLowerCase();
        row.style.display = (!v||name.includes(v))?'':'none';
      });
    }
    searchInput.addEventListener('input',filterTable);

    modalCancel.addEventListener('click',()=>modalOverlay.style.display='none');
    modalOverlay.addEventListener('click',e=>{if(e.target===modalOverlay) modalOverlay.style.display='none';});

    modalSave.addEventListener('click',async()=>{
      if(!activeRow) return;
      const v=parseInt(modalInput.value,10);
      if(isNaN(v)||v<0){alert('Nombre entier ≥ 0.');return;}
      const id=activeRow.dataset.id;
      await updateDoc(doc(db,'produits',id),{stock:v});
      await addDoc(logsCol,{message:`Stock mis à jour pour "${activeRow.querySelector('.cell-name').textContent}" : ${v}`,timestamp:serverTimestamp()});
      activeRow.querySelector('td.stock').textContent=v;
      activeRow.querySelector('td.current').textContent=v;
      activeRow.classList.remove('seuil-orange','seuil-rouge');
      const o=+activeRow.dataset.seuilOrange, r=+activeRow.dataset.seuilRouge;
      if(v<=r) activeRow.classList.add('seuil-rouge'); else if(v<=o) activeRow.classList.add('seuil-orange');
      modalOverlay.style.display='none';
    });

    window.addEventListener('DOMContentLoaded', loadAllProducts);
  </script>
</body>
</html>