<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pharmacie MTIR – Gestion du Stock</title>

  <!-- Roboto + Material Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  />

  <style>
    /* ================================
       RESET & VARIABLES
       ================================ */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      height:100%; font-family:"Roboto",sans-serif;
      background:#f5f5f5; color:#333;
    }
    :root {
      --sidebar-width:240px; --sidebar-bg:#fff; --sidebar-border:#e0e0e0;
      --text-color:#495057; --heading-color:#6c757d;
      --active-bg:#f3f4f6; --active-border:#5c7cfa;
      --icon-color:#6c757d; --hover-bg:#f8f9fa;
      --card-bg:#fff; --card-shadow:rgba(0,0,0,0.05);
      --accent-color:#4b9eff; --table-header-bg:#f1f3f5;
      --table-row-hover:#f9f9f9; --modal-overlay:rgba(0,0,0,0.4);
      --modal-bg:#fff; --category-bg:#eef3f7;
      --search-bg:#f0f4f8; --search-border:#d1d7de;
      --search-placeholder:#8a8f97;
    }

    /* SIDEBAR */
    .sidebar {
      width:var(--sidebar-width); background:var(--sidebar-bg);
      border-right:1px solid var(--sidebar-border);
      position:fixed; top:0; left:0; bottom:0;
      display:flex; flex-direction:column; padding-top:24px;
      overflow-y:auto; scrollbar-width:none; -ms-overflow-style:none;
    }
    .sidebar::-webkit-scrollbar { display:none; }
    /* ... le reste de votre CSS existant ... */

    /* LIGNE DRAG & DROP VISUAL */
    .dragging {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <!-- ==============================================
       SIDEBAR
       ================================================ -->
  <aside class="sidebar">
    <!-- ... votre markup de sidebar ... -->
  </aside>

  <!-- ==============================================
       CONTENU PRINCIPAL (Gestion du Stock)
       ================================================ -->
  <div class="content">
    <div class="page-header">
      <h1>Gestion du Stock</h1>
      <input type="text" id="searchInput" placeholder="Rechercher un produit…" />
    </div>

    <table class="stock-table">
      <thead>
        <tr>
          <th>Nom du produit</th>
          <th>Quantité en stock</th>
          <th>Quantité actuelle</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="stockTbody">
        <!-- Rempli dynamiquement -->
      </tbody>
    </table>
  </div>

  <!-- ==============================================
       MODAL DE MODIFICATION DE STOCK
       ================================================ -->
  <div class="modal-overlay" id="modalOverlay">
    <!-- ... modal existant ... -->
  </div>

  <!-- ==============================================
       SCRIPT JAVASCRIPT (MODULE FIRESTORE + DnD + FILTRAGE)
       ================================================ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs,
      updateDoc, doc, orderBy, query
    } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // Config & init Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB-jAqqfgoJIuJkEWojc5LCGsRnWu6J3lQ",
      authDomain: "pharmacie-mtir-db.firebaseapp.com",
      projectId: "pharmacie-mtir-db",
      storageBucket: "pharmacie-mtir-db.firebasestorage.app",
      messagingSenderId: "840095043695",
      appId: "1:840095043695:web:5841203196acfd400c7d9a",
      measurementId: "G-TW0H23MKSJ"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const produitsCol = collection(db, "produits");

    // Masquage admin-only
    function getQueryParams(){
      const params = {};
      window.location.search.substring(1).split("&").forEach(pair=>{
        if(!pair) return;
        const [k,v] = pair.split("=");
        params[decodeURIComponent(k)] = decodeURIComponent(v||"");
      });
      return params;
    }
    const role = getQueryParams().role||"user";
    if(role!=="admin"){
      document.querySelectorAll(".nav-group.admin-only")
        .forEach(el=>el.style.display="none");
    }

    // Références DOM
    const stockTbody   = document.getElementById("stockTbody");
    const modalOverlay = document.getElementById("modalOverlay");
    const modalInput   = document.getElementById("modalInput");
    const modalCancel  = document.getElementById("modalCancel");
    const modalSave    = document.getElementById("modalSave");
    const searchInput  = document.getElementById("searchInput");
    let activeRow      = null;

    // Création ligne catégorie
    function addCategoryRow(cat){
      const tr = document.createElement("tr");
      tr.classList.add("category-row");
      tr.innerHTML = `<td colspan="4">Catégorie : ${cat}</td>`;
      stockTbody.appendChild(tr);
    }

    // Création ligne produit (draggable)
    function addProductRow(prod){
      const tr = document.createElement("tr");
      tr.dataset.id = prod.id;
      tr.setAttribute("draggable","true");
      tr.innerHTML = `
        <td class="cell-name">${prod.name}</td>
        <td class="stock">${prod.stock}</td>
        <td class="current">${prod.stock}</td>
        <td class="edit"><span class="material-icons">edit</span></td>
      `;

      // DnD : début
      tr.addEventListener("dragstart", e=>{
        e.dataTransfer.setData("text/plain", prod.id);
        tr.classList.add("dragging");
      });
      tr.addEventListener("dragend", ()=>{
        tr.classList.remove("dragging");
        // Après dépôt: mettre à jour l'ordre dans Firestore si nécessaire
        const rows = Array.from(stockTbody.querySelectorAll("tr:not(.category-row)"));
        rows.forEach(async (r, idx) => {
          const id = r.dataset.id;
          await updateDoc(doc(db, "produits", id), { order: idx });
        });
      });
      tr.addEventListener("dragover", e=>{
        e.preventDefault();
        const dragging = document.querySelector(".dragging");
        if (!dragging || dragging === tr) return;
        const rect = tr.getBoundingClientRect();
        const before = (e.clientY - rect.top) < rect.height / 2;
        tr.parentNode.insertBefore(dragging, before ? tr : tr.nextSibling);
      });
      // DnD : fin

      // Edit stock
      tr.querySelector("td.edit .material-icons").addEventListener("click", ()=>{
        activeRow = tr;
        modalInput.value = tr.querySelector("td.stock").textContent.trim();
        modalOverlay.style.display = "flex";
        modalInput.focus();
      });

      stockTbody.appendChild(tr);
    }

    // Charger tous les produits
    async function loadAllProducts(){
      stockTbody.innerHTML = "";
      const q = query(produitsCol, orderBy("__name__", "asc"));
      try {
        const snap = await getDocs(q);
        let lastCat = null;
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const id = docSnap.id;
          const prod = {
            id,
            name: d.name||"",
            category: d.category||"",
            stock: d.stock||0
          };
          if(prod.category !== lastCat){
            addCategoryRow(prod.category);
            lastCat = prod.category;
          }
          addProductRow(prod);
        });
        filterTable();
      } catch(err){
        console.error("Erreur loadAllProducts:", err);
      }
    }

    // Filtrage
    function filterTable(){
      const val = searchInput.value.trim().toLowerCase();
      const rows = Array.from(stockTbody.querySelectorAll("tr"));
      let i = 0;
      while(i < rows.length){
        const row = rows[i];
        if(row.classList.contains("category-row")){
          let any = false, j = i+1;
          while(j<rows.length && !rows[j].classList.contains("category-row")){
            const pr = rows[j];
            const name = pr.querySelector(".cell-name").textContent.toLowerCase();
            if(!val||name.includes(val)){
              pr.style.display="";
              any = true;
            } else {
              pr.style.display="none";
            }
            j++;
          }
          row.style.display = any? "" : "none";
          i = j;
        } else {
          const name = row.querySelector(".cell-name").textContent.toLowerCase();
          row.style.display = (!val||name.includes(val))? "" : "none";
          i++;
        }
      }
    }
    searchInput.addEventListener("input", filterTable);

    // Modal close
    function closeModal(){ modalOverlay.style.display="none"; activeRow=null; }
    modalCancel.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", e=>{
      if(e.target===modalOverlay) closeModal();
    });
    // Save stock
    modalSave.addEventListener("click", async ()=>{
      if(!activeRow) return;
      const v = parseInt(modalInput.value, 10);
      if(isNaN(v)||v<0){ alert("Entrez un entier ≥ 0"); return; }
      const id = activeRow.dataset.id;
      try {
        await updateDoc(doc(db,"produits",id),{ stock:v });
        activeRow.querySelector("td.stock").textContent = v;
        activeRow.querySelector("td.current").textContent = v;
        closeModal();
      } catch(err){
        console.error("Erreur update stock:", err);
      }
    });

    // Init
    window.addEventListener("DOMContentLoaded", loadAllProducts);
  </script>
</body>
</html>