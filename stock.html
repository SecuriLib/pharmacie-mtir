<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pharmacie MTIR – Gestion du Stock</title>

  <!-- Roboto + Material Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    /* RESET & VARIABLES */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background: #f5f5f5; color: #333; overflow-x: hidden; }
    :root {
      --sidebar-w: 240px; --clr-bg: #fff; --clr-border: #e0e0e0;
      --clr-text: #495057; --clr-heading: #34495e; --clr-accent: #4b9eff;
      --clr-hover: #f3f4f6; --clr-card: #fff; --shadow: 0 2px 8px rgba(0,0,0,0.05);
      --table-bg: #fff; --table-header: #f1f3f5; --table-hover: #fafafa;
      --modal-overlay: rgba(0,0,0,0.4); --modal-bg: #fff;
    }
    /* SIDEBAR */
    .sidebar { width: var(--sidebar-w); position: fixed; top: 0; left: 0; height: 100%; background: var(--clr-bg); border-right: 1px solid var(--clr-border); display: flex; flex-direction: column; padding: 24px 0; }
    .sidebar .brand { display: flex; align-items: center; justify-content: center; margin-bottom: 32px; }
    .sidebar .brand .material-icons { font-size: 32px; color: var(--clr-accent); margin-right: 8px; }
    .sidebar .brand-text { font-size: 20px; font-weight: 700; color: var(--clr-text); }
    nav { flex: 1; overflow-y: auto; }
    .group-title { font-size: 12px; color: var(--clr-text); text-transform: uppercase; padding: 0 24px; margin: 16px 0 8px; }
    ul { list-style: none; padding-left: 0; }
    a { display: flex; align-items: center; gap: 12px; padding: 10px 24px; text-decoration: none; color: var(--clr-text); border-right: 4px solid transparent; transition: background .2s; }
    a:hover { background: var(--clr-hover); }
    a.active { background: var(--clr-hover); border-right-color: var(--clr-accent); }
    .logout { padding: 16px; text-align: center; border-top: 1px solid var(--clr-border); }
    .logout a { display: inline-flex; align-items: center; gap: 8px; text-decoration: none; color: var(--clr-text); padding: 8px 16px; border-radius: 4px; transition: background .2s; }
    .logout a:hover { background: var(--clr-hover); }

    /* CONTENT */
    .content { margin-left: var(--sidebar-w); padding: 32px; background: #f5f5f5; min-height: 100vh; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .page-header h1 { font-size: 28px; color: var(--clr-heading); }
    .page-header input { width: 260px; padding: 8px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 20px; }

    /* TABLE STOCK */
    .stock-table { width: 100%; border-collapse: collapse; background: var(--table-bg); box-shadow: var(--shadow); border-radius: 8px; overflow: hidden; }
    .stock-table th, .stock-table td { padding: 12px 16px; }
    .stock-table th { background: var(--table-header); text-transform: uppercase; font-size: 14px; }
    .stock-table tr:nth-child(even) td { background: var(--table-hover); }
    .stock-table tr:hover td { background: #fff; }
    .stock-table td.edit { width: 48px; text-align: center; }
    .stock-table td.edit .material-icons { cursor: pointer; transition: color .2s; }
    .stock-table td.edit .material-icons:hover { color: var(--clr-accent); }

    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--modal-overlay); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal { background: var(--modal-bg); border-radius: 8px; width: 320px; padding: 24px; box-shadow: 0 6px 20px var(--shadow); text-align: center; }
    .modal h2 { margin-bottom: 16px; font-size: 20px; color: var(--clr-heading); }
    .modal input { width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 20px; }
    .modal button { padding: 10px 16px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; margin: 0 8px; transition: background .2s; }
    .btn-cancel { background: #ccc; color: #fff; }
    .btn-cancel:hover { background: #aaa; }
    .btn-save { background: var(--clr-accent); color: #fff; }
    .btn-save:hover { background: #3a8ee6; }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <span class="material-icons">local_pharmacy</span>
      <span class="brand-text">Pharmacie MTIR</span>
    </div>
    <nav>
      <ul><li><a href="dashboard.html?role=admin"><span class="material-icons">dashboard</span>Tableau de bord</a></li></ul>
      <div class="group-title">Gestion du Stock</div>
      <ul><li><a href="stock.html?role=admin" class="active"><span class="material-icons">inventory</span>Stock</a></li><li><a href="produit.html?role=admin"><span class="material-icons">add_box</span>Produits</a></li></ul>
      <div class="group-title">Utilisateurs</div>
      <ul><li><a href="users.html?role=admin"><span class="material-icons">group</span>Utilisateurs</a></li></ul>
      <div class="group-title">Admin</div>
      <ul><li><a href="logs.html?role=admin"><span class="material-icons">receipt_long</span>Logs</a></li></ul>
    </nav>
    <div class="logout"><a href="login.html"><span class="material-icons">logout</span>Déconnexion</a></div>
  </aside>

  <!-- CONTENU PRINCIPAL -->
  <div class="content">
    <div class="page-header">
      <h1>Gestion du Stock</h1>
      <input type="text" id="searchInput" placeholder="Rechercher un produit…" />
    </div>
    <table class="stock-table">
      <thead>
        <tr><th>Nom du produit</th><th>Quantité</th><th>Actuel</th><th></th></tr>
      </thead>
      <tbody id="stockTbody"></tbody>
    </table>
  </div>

  <!-- MODAL de modification -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h2>Modifier la quantité</h2>
      <input type="number" id="modalInput" min="0" />
      <div>
        <button class="btn-cancel" id="modalCancel">Annuler</button>
        <button class="btn-save" id="modalSave">Enregistrer</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs,
      updateDoc, doc, orderBy, query,
      addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // Config Firebase
    const firebaseConfig = { apiKey:"…", authDomain:"…", projectId:"pharmacie-mtir-db", storageBucket:"…", messagingSenderId:"…", appId:"…" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const produitsCol = collection(db, "produits");
    const logsCol     = collection(db, "logs");

    // Récupérer role
    const params = Object.fromEntries(new URLSearchParams(window.location.search));
    const role   = params.role || 'user';

    // DOM refs
    const stockTbody   = document.getElementById("stockTbody");
    const modalOverlay = document.getElementById("modalOverlay");
    const modalInput   = document.getElementById("modalInput");
    const modalCancel  = document.getElementById("modalCancel");
    const modalSave    = document.getElementById("modalSave");
    const searchInput  = document.getElementById("searchInput");
    let activeRow      = null;

    // Ajouter une ligne produit
    function addProductRow(prod) {
      const tr = document.createElement("tr");
      tr.dataset.id = prod.id;
      tr.innerHTML = `
        <td>${prod.name}</td>
        <td>${prod.stock}</td>
        <td>${prod.stock}</td>
        <td class="edit"><span class="material-icons">edit</span></td>
      `;
      tr.querySelector(".material-icons").addEventListener("click", () => {
        activeRow = tr;
        modalInput.value = prod.stock;
        modalOverlay.style.display = 'flex';
      });
      stockTbody.appendChild(tr);
    }

    // Charger tous les produits
    async function loadAllProducts() {
      stockTbody.innerHTML = '';
      const q = query(produitsCol, orderBy("__name__", "asc"));
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const d = docSnap.data();
        addProductRow({ id: docSnap.id, name: d.name, stock: d.stock });
      });
      filterTable();
    }

    // Filtrage
    function filterTable() {
      const val = searchInput.value.trim().toLowerCase();
      document.querySelectorAll('#stockTbody tr').forEach(tr => {
        const nm = tr.children[0].textContent.toLowerCase();
        tr.style.display = nm.includes(val) ? '' : 'none';
      });
    }
    searchInput.addEventListener('input', filterTable);

    // Fermer modal
    function closeModal() { modalOverlay.style.display = 'none'; activeRow = null; }
    modalCancel.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', e => { if(e.target===modalOverlay) closeModal(); });

    // Sauvegarder modification + log
    modalSave.addEventListener('click', async () => {
      if (!activeRow) return;
      const newQty = parseInt(modalInput.value, 10);
      if (isNaN(newQty) || newQty < 0) { alert('Entrez un nombre ≥ 0'); return; }
      const id = activeRow.dataset.id;
      // Mise à jour stock
      await updateDoc(doc(db, 'produits', id), { stock: newQty });
      // Écriture log avec user
      await addDoc(logsCol, {
        message: `Stock mis à jour pour "${activeRow.children[0].textContent}" : ${newQty} unités.`,
        user: role,
        timestamp: serverTimestamp()
      });
      // Mise à jour UI
      activeRow.children[1].textContent = newQty;
      activeRow.children[2].textContent = newQty;
      closeModal();
    });

    window.addEventListener('DOMContentLoaded', loadAllProducts);
  </script>
</body>
</html>